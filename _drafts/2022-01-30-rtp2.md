---
layout: post
title: Raytracing on the GPU
subtitle: Ray Tracing Journey - Pt3
type: blog
permalink: raytracing-part-three
usemathjax: true
---

* TOC
{:toc}

# Raytracing on the GPU

# 1. Hello World RT and OpenCL

{% highlight cpp %}

int pixelCount = renderBuffer.Width * renderBuffer.Height;

cl_float3* cpuPixelBuffer = new cl_float3[pixelCount];
cl::Buffer clPixelBuffer = cl::Buffer(m_Context, CL_MEM_WRITE_ONLY, pixelCount * sizeof(cl_float3), NULL);

m_Kernel.setArg(0, clPixelBuffer);
m_Kernel.setArg(1, renderBuffer.Width);
m_Kernel.setArg(2, renderBuffer.Height);

std::size_t global_work_size = pixelCount;
std::size_t local_work_size = 64; 

m_Queue.enqueueNDRangeKernel(m_Kernel, NULL, global_work_size, local_work_size);
m_Queue.finish();

m_Queue.enqueueReadBuffer(clPixelBuffer, CL_TRUE, 0, pixelCount * sizeof(cl_float3), cpuPixelBuffer);

for (int i = 0; i < renderBuffer.Height; i++)
{
    for (int j = 0; j < renderBuffer.Width; j++)
    {
        cl_float3 color = cpuPixelBuffer[(i * renderBuffer.Width) + j];
        color.x = sqrt(color.x);
        color.y = sqrt(color.y);
        color.z = sqrt(color.z);

        renderBuffer.WriteColor(glm::vec3(color.x, color.y, color.z), i, j);
    }
}

delete[] cpuPixelBuffer;

{% endhighlight %}

{% highlight c %}

__kernel void render_kernel(__global float3* output, int width, int height)
{
    const int work_item_id = get_global_id(0);	// Unique global id of the work item for the current pixel 
    int x_coord = work_item_id % width; // X-coordinate of the pixel 
    int y_coord = work_item_id / width; // Y-coordinate of the pixel 

    float r = (float)x_coord / (float)(width - 1);                 // [0 - 1]
    float g = (float)(height - 1 - y_coord) / (float)(height - 1); // [1 - 0]
    float b = 0.25;

    output[work_item_id] = (float3)(r, g, b);
}

{% endhighlight %}